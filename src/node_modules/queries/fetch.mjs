import fetch from 'node-fetch';

import { endpoints } from '../config.mjs'

export const querySparql = async (endpoint, query, options = {}) => {
	if (endpoint in endpoints) endpoint = endpoints[endpoint];

	let url = new URL(endpoint);
	for (const [key, value] of Object.entries(options)) {
		url.searchParams.append(key, value);
	}

	const bytes = Buffer.byteLength(query, 'utf-8');
	let res;

	if (bytes < 1900) {
		url.searchParams.append('query', query);
		res = await fetch(url);
	} else {
		console.log('Attempting to use POST')
		res = await fetch(endpoint, {
			method: 'post',
			body: query,
			headers: { 'Content-Type': 'application/sparql-query' },
		});
	}

	if (res.ok) {
		const result = await res.text();
		if (!options.quiet) {
			if (options.file)
				console.log(`[+] Fetched results for ${options.file}`);
			else console.log('[+] Succesully fetched query');
		}
		return result;
	} else {
		console.log((await res.text()).slice(0, 1000))
		if (!options.quiet) {
			if (options.file)
				console.error(
					`[-] Failed to fetch results for ${options.file}`
				);
			else console.error('[-] Failed to  fetch query');
		}
	}
};
